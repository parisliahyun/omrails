"use strict";var FS=require("fs"),PATH=require("path"),UTIL=require("util"),CRYPTO=require("crypto"),Error=require("errno-codes");Error.create(Error.getNextAvailableErrno(),"NULL_PATH","Null path."),Error.create(Error.getNextAvailableErrno(),"SECURITY_READ",'Security error, cannot read "{path}".'),Error.create(Error.getNextAvailableErrno(),"SECURITY_WRITE",'Security error, cannot write "{path}".'),Error.create(Error.getNextAvailableErrno(),"PATH_NO_DIR",'The path "{path}" is not a directory.'),Error.create(Error.getNextAvailableErrno(),"PATH_NO_FILE",'The path "{path}" is not a file.'),Error.create(Error.getNextAvailableErrno(),"DEEP","The deep must be greater than 0.");var SLASH=PATH.normalize("/"),SM=null,EXISTS=FS.exists||PATH.exists,EXISTS_SYNC=FS.existsSync||PATH.existsSync,updateFileProperties=function(a,b){a._path=null,a._usablePath=null,a._isAbsolute=!1,b.parent instanceof File&&(b.parent=b.parent._path),b.parent=PATH.normalize(b.parent);var c=b.parent.indexOf(":")+1,d=b.parent.substring(0,c);b.parent=b.parent.substring(c),b.parent[0]==="/"&&b.parent[1]==="/"&&(b.parent=b.parent.replace(/[\/]/g,"\\"),b.parent=b.parent.substring(0,b.parent.length-1)),a._isAbsolute=b.parent[0]===SLASH,b.child!==undefined&&b.child!==null&&(b.child instanceof File&&(b.child=b.child._path),b.parent=PATH.join(b.parent,PATH.normalize(b.child))),a._path=d+b.parent,a._usablePath=a._isAbsolute?a._path:d+PATH.join(a._relative,b.parent)},File=function(a,b){if(!a)throw Error.get(Error.NULL_PATH);var c=process.mainModule.filename,d=c.substring(0,c.lastIndexOf(SLASH)),e=PATH.relative(process.cwd(),d),f=this;this._relative=e,this._removeOnExit=!1,this._removeOnExitCallback=function(a){if(!f._removeOnExit)return;var b=removeSynchronous(f);a&&a(b.error,b.removed)},this._removeOnExitCallback.first=!0,updateFileProperties(this,{parent:a,child:b})},canReadSM=function(a){return SM?!!(SM._getPermissions(a)&SecurityManager.READ):!0},canWriteSM=function(a){return SM?!!(SM._getPermissions(a)&SecurityManager.WRITE):!0},checkPermission=function(a,b,c){FS.stat(a,function(a,d){a?c(a,!1):c(null,!!(b&parseInt((d.mode&parseInt("777",8)).toString(8)[0])))})},setPermission=function(a,b,c,d){FS.stat(a,function(e,f){if(e)d&&d(e,!1);else{var g=(f.mode&parseInt("777",8)).toString(8),h=parseInt(g[0]),i=!!(h&b);if(i&&!c||!i&&c){var j=c?b:-b;FS.chmod(a,j+h+g.substring(1),function(a){d&&d(a,!a)})}else d&&d(null,!1)}})};File.prototype.canExecute=function(a){if(!a)return;a=a.bind(this);if(!canReadSM(this._usablePath))return a(Error.get(Error.SECURITY_READ,{path:this._usablePath}),!1);checkPermission(this._usablePath,1,a)},File.prototype.canRead=function(a){if(!a)return;a=a.bind(this);if(!canReadSM(this._usablePath))return a(Error.get(Error.SECURITY_READ,{path:this._usablePath}),!1);checkPermission(this._usablePath,4,a)},File.prototype.canWrite=function(a){if(!a)return;a=a.bind(this);if(!canReadSM(this._usablePath))return a(Error.get(Error.SECURITY_READ,{path:this._usablePath}),!1);checkPermission(this._usablePath,2,a)},File.prototype.checksum=function(a,b,c){arguments.length===2&&typeof b=="function"&&(c=b,b="hex");if(!c)return;c=c.bind(this);if(!canReadSM(this._usablePath))return c(Error.get(Error.SECURITY_READ,{path:this._usablePath}),null);var d=this;FS.stat(this._usablePath,function(e,f){if(e)c(e,null);else if(f.isDirectory())c(Error.get(Error.PATH_NO_FILE,{path:d._usablePath}),null);else if(f.isFile()){a=CRYPTO.createHash(a);var g=FS.ReadStream(d._usablePath);g.on("error",function(a){c(a,null)}),g.on("data",function(b){a.update(b)}),g.on("end",function(){c(null,a.digest(b))})}})},File.prototype.contains=function(a,b){if(!b)return;a instanceof File||(a=new File(a)),a=a.getName(),list(null,b,this,!1,a,null)},File.prototype.copy=function(a,b,c){var d=arguments.length;d===1?b=!1:d===2&&typeof b=="function"&&(c=b,b=!1),c&&(c=c.bind(this));if(!canReadSM(this._usablePath)){c&&c(Error.get(Error.SECURITY_READ,{path:this._usablePath}),!1);return}a instanceof File||(a=new File(a));var e=a._path;a=a._usablePath;if(!canWriteSM(a)){c&&c(Error.get(Error.SECURITY_WRITE,{path:a}),!1);return}var f=this,g=function(){var b=FS.createWriteStream(a);b.on("error",function(a){c&&c(a,!1)}),b.once("open",function(a){UTIL.pump(FS.createReadStream(f._usablePath),b,function(a){a=a===undefined?null:a,c&&c(a,!a)})})},h=function(){FS.mkdir(a,function(a){a?c&&c(a,!1):FS.readdir(f._usablePath,function(a,b){if(a)c&&c(a,!1);else{var d=b.length,g=0;b.forEach(function(a){(new File(PATH.join(f._path,a))).copy(PATH.join(e,a),function(a,b){a?c&&c(a,!1):(g++,g===d&&c&&c(null,!0))})})}})})};FS.stat(this._usablePath,function(d,f){d?c&&c(d,!1):EXISTS(a,function(a){a&&!b?c&&c(null,!1):f.isFile()?g():f.isDirectory()&&(a&&b?(new File(e)).remove(function(a,b){a?c&&c(a,!1):h()}):h())})})},File.prototype.createDirectoriesFromJSON=function(a,b){b&&(b=b.bind(this));if(!canWriteSM(this._usablePath)){b&&b(Error.get(Error.SECURITY_WRITE,{path:this._usablePath}),!1);return}var c=!1,d=!1,e=function(a,b,f){var g=Object.keys(b),h=g.length,i=0;if(h===0)return f(null);for(var j=0;j<h;j++)(function(g,j){var k=PATH.join(a,g);FS.mkdir(k,function(a){d=h-1===j;if(a&&a.code!=="EEXIST"){f(a);return}a||(c=!0),e(k,b[g],function(a){if(a)return f(a);i++,i===h&&f(null)})})})(g[j],j)},f=this,g=[];e(this._usablePath,a,function(a){a&&g.push(a),d&&(g=g.length===0?null:g,b&&b(g,g?!1:c))})},File.prototype.createDirectory=function(a){a&&(a=a.bind(this));if(!canWriteSM(this._usablePath)){a&&a(Error.get(Error.SECURITY_WRITE,{path:this._usablePath}),!1);return}var b=function(a,c){a.exists(function(d){if(d)return c(null,!1);FS.mkdir(a.getPath(),function(d){if(!d)return c(null,!0);var e=a.getParentFile();if(e===null)return c(null,!1);b(e,function(b,d){d?FS.mkdir(a.getPath(),function(a){c(a,!a)}):e.exists(function(b){if(!b)return c(null,!1);FS.mkdir(a.getPath(),function(a){c(a,!a)})})})})})};b(this.getAbsoluteFile(),function(b,c){a&&a(b,c)})},File.prototype.createNewFile=function(a){a&&(a=a.bind(this));if(!canWriteSM(this._usablePath)){a&&a(Error.get(Error.SECURITY_WRITE,{path:this._usablePath}),!1);return}var b=this;EXISTS(this._usablePath,function(c){c?a&&a(null,!1):FS.createWriteStream(b._usablePath).on("error",function(b){a&&a(b,!1)}).on("close",function(){a&&a(null,!0)}).end()})},File.createTempFile=function(a,b){arguments.length===1&&typeof a=="function"&&(b=a,a=null);var c="",d="",e=".";a&&(c=a.prefix?a.prefix:c,d=a.suffix?a.suffix:d,e=a.directory?a.directory.toString():e);var f=Math.floor(Math.random()*1e12),g=new File(e,c+f+d);if(!canWriteSM(g._usablePath)){b&&b(Error.get(Error.SECURITY_WRITE,{path:g._usablePath}),!1);return}EXISTS(g._usablePath,function(c){c?File.createTempFile(a,b):(g.removeOnExit(),FS.createWriteStream(g._usablePath).on("error",function(a){b&&b(a,null)}).on("close",function(){b&&b(null,g)}).end())})},File.createTempFolder=function(a,b){arguments.length===1&&typeof a=="function"&&(b=a,a=null);var c="",d="",e=".";a&&(c=a.prefix?a.prefix:c,d=a.suffix?a.suffix:d,e=a.directory?a.directory.toString():e);var f=Math.floor(Math.random()*1e12),g=new File(e,c+f+d);if(!canWriteSM(g._usablePath)){b&&b(Error.get(Error.SECURITY_WRITE,{path:g._usablePath}),!1);return}EXISTS(g._usablePath,function(c){c?File.createTempFolder(a,b):(g.removeOnExit(),g.createDirectory(function(a,c){a?b&&b(a,null):b&&b(null,g)}))})},File.prototype.equals=function(a){var b=a instanceof File?a.getAbsolutePath():(new File(a)).getAbsolutePath();return b===this.getAbsolutePath()},File.prototype.exists=function(a){if(!a)return;a=a.bind(this);if(!canReadSM(this._usablePath))return a(Error.get(Error.SECURITY_READ,{path:this._usablePath}),!1);EXISTS(this._usablePath,function(b){a(b)})},File.prototype.getAbsoluteFile=function(){return new File(this.getAbsolutePath())},File.prototype.getAbsolutePath=function(){return this._path?this._isAbsolute?this._path:PATH.join(PATH.dirname(process.mainModule.filename),this._path.substring(this._path.indexOf(":")+1)):null},File.prototype.getBaseName=function(){if(!this._path)return null;var a=this.getName(),b=this.getExtension();return b?a.substring(0,a.length-(b.length+1)):a},File.prototype.getExtension=function(){if(!this._path)return null;var a=PATH.extname(this._path);return a[0]==="."?a.substr(1):a},File.prototype.getName=function(){if(!this._path)return null;var a=PATH.basename(this._path);return a==="."?"":a},File.prototype.getOriginalPath=function(){return this._path},File.prototype.getParent=function(){if(!this._path)return null;var a=this._path.lastIndexOf(SLASH);return a===-1?null:a===0?this._path===SLASH?null:"/":this._path.substring(0,a)},File.prototype.getParentFile=function(){var a=this.getParent();return a===null?null:new File(a)},File.prototype.getPath=function(){return this._usablePath},File.prototype.getPermissions=function(a){if(!a)return;a=a.bind(this);if(!canReadSM(this._usablePath))return a(Error.get(Error.SECURITY_READ,{path:this._usablePath}),null);FS.stat(this._usablePath,function(b,c){b?a(b,null):a(null,(c.mode&parseInt("777",8)).toString(8))})},File.prototype.isAbsolute=function(){return this._isAbsolute},File.prototype.isDirectory=function(a){if(!a)return;a=a.bind(this);if(!canReadSM(this._usablePath))return a(Error.get(Error.SECURITY_READ,{path:this._usablePath}),!1);FS.stat(this._usablePath,function(b,c){b?a(b,!1):a(null,c.isDirectory())})},File.prototype.isEmpty=function(a){if(!a)return;a=a.bind(this);if(!canReadSM(this._usablePath))return a(Error.get(Error.SECURITY_READ,{path:this._usablePath}),!1);var b=this;FS.stat(this._usablePath,function(c,d){c?a&&a(c,!1):d.isFile()?a&&a(Error.get(Error.PATH_NO_DIR,{path:b._usablePath}),!1):d.isDirectory()&&FS.readdir(b._usablePath,function(b,c){if(b){a&&a(b,!1);return}a&&a(null,c.length===0)})})},File.prototype.isFile=function(a){if(!a)return;a=a.bind(this);if(!canReadSM(this._usablePath))return a(Error.get(Error.SECURITY_READ,{path:this._usablePath}),!1);FS.stat(this._usablePath,function(b,c){b?a(b,!1):a(null,c.isFile())})},File.prototype.isHidden=function(){return this.getName()[0]==="."},File.prototype.isRoot=function(){var a=this.getAbsolutePath();return a.substring(a.indexOf(":")+1)===SLASH},File.prototype.lastModified=function(a){if(!a)return;a=a.bind(this);if(!canReadSM(this._usablePath))return a(Error.get(Error.SECURITY_READ,{path:this._usablePath}),null);FS.stat(this._usablePath,function(b,c){b?a(b,null):a(null,Date.parse(c.mtime))})};var list=function(a,b,c,d,e,f){b&&(b=b.bind(c));if(!canReadSM(c._usablePath))return b(Error.get(Error.SECURITY_READ,{path:c._usablePath}),e?!1:null);var g=!1,h=!1;FS.stat(c._usablePath,function(i,j){if(i)b&&b(i,e?!1:null);else if(j.isFile())b&&b(Error.get(Error.PATH_NO_DIR,{path:c._usablePath}),e?!1:null);else if(j.isDirectory()){var k=function(a,b,c,d){if(!a)return d(c);var e=[],f,g=!1,h=c.length;c.forEach(function(c){var f=null,i=a(c,PATH.join(b,c),function(a){a&&e.push(c),h--,h===0&&d(e)});i===undefined?g=!0:(h--,i&&e.push(c))}),g||d(e)},l=function(a,c,i,j,m,n){m++,FS.readdir(a,function(o,p){if(o){n&&n(o,e?!1:null);return}k(j,c,p,function(k){var o=k.length,p=0,q=function(){return p===o?(n&&(e?n(null,!1):n(null,i)),!0):!1};if(q())return;var r=k.length;for(var s=0;s<r&&!g;s++)(function(k){var o=PATH.join(c,k);FS.stat(PATH.join(a,k),function(c,r){if(c){n&&n(c,e?!1:null);return}if(r.isFile()){if(e&&k===e&&!h)return h=!0,g=!0,b(null,!0);i[k]=d?new File(o):o,p++,q()}else if(r.isDirectory()){i[k]={};if(m===f){p++,q();return}l(PATH.join(a,k),o,i[k],j,m,function(a,b){if(a){n&&n(a,e?!1:null);return}p++,q()})}})})(k[s])})})};l(c._usablePath,c._path,{},a,0,b)}})};File.prototype.list=function(a,b,c){var d=arguments.length;if(d===0)return;d===1?(c=a,a=null,b=null):d===2&&(typeof a=="number"?(c=b,b=a,a=null):(c=b,b=null));if(b!==null&&b<1)return c(Error.get(Error.DEEP),null);list(a,c,this,!1,null,b)},File.prototype.listFiles=function(a,b,c){var d=arguments.length;if(d===0)return;d===1?(c=a,a=null,b=null):d===2&&(typeof a=="number"?(c=b,b=a,a=null):(c=b,b=null));if(b!==null&&b<1)return c(Error.get(Error.DEEP),null);list(a,c,this,!0,null,b)},File.protect=function(a){SM=a},File.prototype.remove=function(a){a&&(a=a.bind(this));if(!canWriteSM(this._usablePath)){a&&a(Error.get(Error.SECURITY_WRITE,{path:this._usablePath}),!1);return}var b=this;FS.stat(this._usablePath,function(c,d){if(c){a&&a(c,!1);return}d.isFile()?FS.unlink(b._usablePath,function(b){a&&(b?a(b,!1):a(null,!0))}):d.isDirectory()&&FS.readdir(b._usablePath,function(c,d){if(c){a&&a(c,!1);return}var e=d.length,f=0,g=function(){return e===f?(FS.rmdir(b._usablePath,function(b){a&&(b?a(b,!1):a(null,!0))}),!0):!1};if(g())return;for(var h in d)(new File(PATH.join(b._path,d[h]))).remove(function(b,c){b?a&&a(b,!1):(f++,g())})})})};var removeSynchronous=function(a){if(!canWriteSM(a._usablePath))return{error:Error.get(Error.SECURITY_WRITE,{path:a._usablePath}),removed:!1};if(!EXISTS_SYNC(a._usablePath))return{error:null,removed:!1};var b=FS.statSync(a._usablePath),c;if(b.isFile())FS.unlinkSync(a._usablePath);else if(b.isDirectory()){var d=FS.readdirSync(a._usablePath);for(var e in d){c=removeSynchronous(new File(PATH.join(a._path,d[e])));if(c.error)return{error:c.error,removed:c.removed}}FS.rmdirSync(a._usablePath)}return{error:null,removed:!0}};File.prototype.removeOnExit=function(a,b){var c=arguments.length;c===0?a=!0:c===1&&typeof a=="function"&&(b=a,a=!0),b&&(b=b.bind(this)),this._removeOnExit=a;if(a&&this._removeOnExitCallback.first){this._removeOnExitCallback.first=!1;var d=this;process.on("exit",function(){d._removeOnExitCallback(b)})}},File.prototype.rename=function(a,b,c){var d=arguments.length;d===1?b=!1:d===2&&typeof b=="function"&&(c=b,b=!1),c&&(c=c.bind(this)),a instanceof File||(a=new File(a));if(!canWriteSM(this._usablePath)){c&&c(Error.get(Error.SECURITY_WRITE,{path:this._usablePath}),!1);return}if(!canWriteSM(a._usablePath)){c&&c(Error.get(Error.SECURITY_WRITE,{path:a._usablePath}),!1);return}var e=a._path;a=a._usablePath;var f=this,g=function(){FS.rename(f._usablePath,a,function(a){a?c&&c(a,!1):(updateFileProperties(f,{parent:e}),c&&c(null,!0))})};b?g():EXISTS(a,function(a){a?c&&c(null,!1):g()})};var search=function(a,b,c,d){if(!b)return;b=b.bind(c);if(!canReadSM(c._usablePath))return b(Error.get(Error.SECURITY_READ,{path:thisFile._usablePath}),null);a instanceof File&&(a=a.getName());var e=[];c.list(function(b,c){return b===a&&e.push(d?new File(c):c),!0},function(a){a?b(a,null):b(null,e)})};File.prototype.search=function(a,b){search(a,function(a,c){b&&b(a,c)},this,!1)},File.prototype.searchFiles=function(a,b){search(a,function(a,c){b&&b(a,c)},this,!0)},File.prototype.setExecutable=function(a,b){var c=arguments.length;c===0?a=!0:c===1&&typeof a=="function"&&(b=a,a=!0),b&&(b=b.bind(this)),process.platform==="win32"&&b&&b(null,!1);if(!canWriteSM(this._usablePath)){b&&b(Error.get(Error.SECURITY_WRITE,{path:this._usablePath}),!1);return}setPermission(this._usablePath,1,a,b)},File.prototype.setPermissions=function(a,b){b&&(b=b.bind(this));if(!canWriteSM(this._usablePath)){b&&b(Error.get(Error.SECURITY_WRITE,{path:this._usablePath}),!1);return}FS.chmod(this._usablePath,a,function(a){b&&b(a,!a)})},File.prototype.setReadable=function(a,b){var c=arguments.length;c===0?a=!0:c===1&&typeof a=="function"&&(b=a,a=!0),b&&(b=b.bind(this)),process.platform==="win32"&&b&&b(null,!1);if(!canWriteSM(this._usablePath)){b&&b(Error.get(Error.SECURITY_WRITE,{path:this._usablePath}),!1);return}setPermission(this._usablePath,4,a,b)},File.prototype.setReadOnly=function(a){a&&(a=a.bind(this));if(!canWriteSM(this._usablePath)){a&&a(Error.get(Error.SECURITY_WRITE,{path:this._usablePath}),!1);return}FS.chmod(this._usablePath,"444",function(b){a(b,!b)})},File.prototype.setWritable=function(a,b){var c=arguments.length;c===0?a=!0:c===1&&typeof a=="function"&&(b=a,a=!0),b&&(b=b.bind(this));if(!canWriteSM(this._usablePath)){b&&b(Error.get(Error.SECURITY_WRITE,{path:this._usablePath}),!1);return}setPermission(this._usablePath,2,a,b)},File.prototype.size=function(a){if(!a)return;a=a.bind(this);if(!canReadSM(this._usablePath))return a(Error.get(Error.SECURITY_READ,{path:this._usablePath}),0);var b=0,c=this,d=function(a){FS.stat(c._usablePath,function(d,e){d?a(d,null):e.isFile()?a(null,e.size):e.isDirectory()&&FS.readdir(c._usablePath,function(d,e){var f=e.length,g=0,h=function(){return g===f?(a(null,b),!0):!1};if(h())return;e.forEach(function(d){(new File(PATH.join(c._path,d))).size(function(c,d){c?a(c,0):(b+=d,g++,h())})})})})};d(a)},File.prototype.toString=function(){return this._path};var SecurityManager=function(){this._permissions={};var a=(new File(".")).getAbsolutePath().replace(/\\/g,"/");this._permissions[a]=SecurityManager.READ_WRITE};SecurityManager.NONE=0,SecurityManager.READ=1,SecurityManager.WRITE=2,SecurityManager.READ_WRITE=3;var getAbsolutePath=function(a){return a instanceof File?a.getAbsolutePath():(new File(a)).getAbsolutePath()};SecurityManager.prototype._getPermissions=function(a){a=getAbsolutePath(a).replace(/\\/g,"/");var b={path:null,perm:null};for(var c in this._permissions){var d=new RegExp("^"+c);a.match(d)&&(!b.path||!b.path.match(d))&&(b.path=c,b.perm=this._permissions[c])}return b.path?b.perm:SecurityManager.READ},SecurityManager.prototype.allow=function(a,b){this._permissions[getAbsolutePath(a).replace(/\\/g,"/")]=b},SecurityManager.prototype.deny=function(a,b){this._permissions[getAbsolutePath(a).replace(/\\/g,"/")]=~b},module.exports={File:File,SecurityManager:SecurityManager};